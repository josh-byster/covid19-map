<!DOCTYPE html>
<meta charset="utf-8" />
<style>
  svg {
    display: block;
    margin-left: auto;
    margin-right: auto;
  }
  path {
    fill: #ccc;
    stroke: #fff;
    stroke-width: 0.01px;
  }

  div.tooltip {
    position: absolute;
    text-align: center;
    /* width: 50px; */
    /* height: 50px; */
    padding: 10px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0px;
    border-radius: 8px;
    pointer-events: none;
  }
  circle {
    transition: fill-opacity 0.5s ease-in-out;
    fill-opacity: 0.3;
    stroke: #fff;
    stroke-width: 0.1px;
  }
  circle.hover {
    fill-opacity: 0.7;
    transition: fill-opacity 0.5s ease-in-out;
  }
</style>
<body>
  <script src="https://d3js.org/d3.v5.js"></script>
  <script src="https://unpkg.com/topojson@3"></script>
  <script>
    const width = 1400,
      height = 800;
    const CUR_DATE = "3/13/20";
    const MIN = 0;
    const MAX = 70000;
    const toColor = d3
      .scaleSequentialSqrt(d3.interpolateYlOrRd)
      .domain([MIN, 35000]);
    const projection = d3
      .geoMercator()
      .scale(200)
      .translate([width / 2, height / 2]);
    const path = d3.geoPath(projection);

    const svg = d3
      .select("body")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    // Define the div for the tooltip
    const tooltip = d3
      .select("body")
      .append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

    const url = "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-10m.json";

    d3.json(url)
      .then(topology => {
        console.log(topology);

        console.log("topojson", topology.objects.countries);
        const geojson = topojson.feature(topology, topology.objects.countries);
        console.log("geojson", geojson);

        svg
          .selectAll("path")
          .data(geojson.features)
          .enter()
          .append("path")
          .attr("d", path);
      })
      .then(_ =>
        d3.csv(
          "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv"
        )
      )
      .then(data => {
        const filtered = data
          .filter(d => d[CUR_DATE] > 0)
          .map(d => ({
            lat: d.Lat,
            long: d.Long,
            country: d["Country/Region"],
            count: d[CUR_DATE],
            province: d["Province/State"]
          }));
        console.log(filtered);
        svg
          .append("g")
          .attr("class", "bubble")
          .selectAll("circle")
          .data(filtered)
          .enter()
          .append("circle")
          .attr("r", function(d) {
            const t = d3
              .scaleSqrt()
              .domain([MIN, MAX])
              .range([0, 100]);
            return t(d.count);
            // return radius(d.properties.population); //radius const with input (domain) and output (range)
          })
          .attr("transform", function(d) {
            return "translate(" + projection([d.long, d.lat]) + ")";
          })
          .attr("fill", d => {
            return toColor(d.count);
          })
          //add Tool Tip
          .on("mouseover", function(d) {
            d3.select(this).classed("hover", true);
            tooltip
              .transition()
              .duration(200)
              .style("opacity", 0.9);
            tooltip
              .html(
                `${d.province ? d.province + "<br/>" : ""}${
                  d.country
                }<br/>Confirmed: ${d.count}`
              )
              .style("left", d3.event.pageX + "px")
              .style("top", d3.event.pageY + "px");
          })
          .on("mouseout", function(d) {
            d3.select(this).classed("hover", false);
            tooltip
              .transition()
              .duration(500)
              .style("opacity", 0);
          });
      });
  </script>
</body>
